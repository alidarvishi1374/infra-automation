<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>S3 Panel - Buckets</title>
    <link rel="icon" type="image/svg" href="{{ url_for('static', filename='img/aws-logo.svg') }}">
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <!-- Fonts & Custom CSS -->
    <link href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/sb-admin-2.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .badge-lg {
            padding: 8px 12px;
            font-size: 14px;
        }
        .json-viewer {
            background: #f8f9fa;
            border: 1px solid #e3e6f0;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .action-btn {
            margin: 2px;
            min-width: 120px;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        .card {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            border: none;
        }
        .bucket-tags-pretty {
            margin-top: 5px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
            max-width: 200px;
            margin: 0 auto;
        }

        .tag-pretty {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .tag-pretty:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .tag-pretty {
            background: linear-gradient(135deg, #e8e04e 0%, #fef100 100%);
            color: rgb(4, 3, 3);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tag-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
        }

        .no-tags-pretty {
            color: #6c757d;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
        }

        .no-tags-pretty i {
            font-size: 10px;
            opacity: 0.6;
        }

        .dropdown-menu {
            min-width: 200px;
        }

        .dropdown-item {
            padding: 8px 15px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
            margin-right: 8px;
        }

        /* DataTables Custom Styles */
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 4px 8px;
            margin: 0 2px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #007bff;
            color: white !important;
            border-color: #007bff;
        }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 15px;
        }

        .dataTables_wrapper .dataTables_info {
            padding-top: 15px;
        }

        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            padding: 0.375rem 0.75rem;
        }

        .dataTables_wrapper .dataTables_length select {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            padding: 0.375rem 0.75rem;
        }

        /* Custom positioning for length menu */
        .dataTables_length {
            float: left !important;
        }

        .dataTables_filter {
            float: right !important;
        }

        .dataTables_info {
            float: left !important;
        }

        .dataTables_paginate {
            float: right !important;
        }
    </style>
</head>
<body id="page-top">
<div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <!-- Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
            <div class="sidebar-brand-icon rotate-n-13">
                <i class="fab fa-aws" style="color: orange;"></i>
            </div>
            <div class="sidebar-brand-text mx-3">S3 Panel</div>
        </a>
        <hr class="sidebar-divider my-0">
        <!-- Dashboard -->
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('bucket.home') }}">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </li>
        <hr class="sidebar-divider">
        <div class="sidebar-heading">Interface</div>
        
        <li class="nav-item active">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseBuckets"
               aria-expanded="true" aria-controls="collapseBuckets">
                <i class="fa fa-cubes" aria-hidden="true"></i>
                <span>Buckets</span>
            </a>
            <div id="collapseBuckets" class="collapse show" aria-labelledby="headingBuckets" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item active" href="{{ url_for('bucket.buckets') }}">Buckets</a>
                </div>
            </div>
        </li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseObjects"
               aria-expanded="true" aria-controls="collapseObjects">
                <i class="fas fa-database" aria-hidden="true"></i>
                <span>Objects</span>
            </a>
            <div id="collapseObjects" class="collapse" aria-labelledby="headingObjects" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" href="{{ url_for('objects.all_buckets') }}">Objects</a>
                </div>
            </div>
        </li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseS3select">
                <i class="fas fa-table"></i><span>S3select</span>
            </a>
            <div id="collapseS3select" class="collapse">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" href="{{ url_for('s3_select.s3_select_page') }}">S3select</a>
                </div>
            </div>
        </li>

        {% if user_info.type == "Root Account" %}
        <li class="nav-item">
            <a class="nav-link" href="#" data-toggle="collapse" data-target="#collapseIAM"
               aria-expanded="true" aria-controls="collapseIAM">
                <i class="fa fa-key" aria-hidden="true"></i>
                <span>IAM</span>
            </a>
            <div id="collapseIAM" class="collapse" aria-labelledby="headingIAM" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" href="{{ url_for('user.iam_users') }}">Users</a>
                    <a class="collapse-item" href="{{ url_for('iam_groups.iam_groups') }}">Groups</a>
                </div>
            </div>
        </li>
        {% endif %}
        
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseSts"
                aria-expanded="true" aria-controls="collapseSts">
                <i class="fas fa-theater-masks"></i>
                <span>STS</span>
            </a>
            <div id="collapseSts" class="collapse" aria-labelledby="headingObjects" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    {% if user_info.type == "Root Account" %}
                    <a class="collapse-item" href="{{ url_for('manage.manage_sts_permissions') }}">Admin Permission</a>
                    <a class="collapse-item" href="{{ url_for('manage_iam.manage_roles_page') }}">Role Management</a>
                    {% endif %}
                    <a class="collapse-item" href="{{ url_for('assume_roles.assume_roles_page') }}">Assume Role</a>
                </div>
            </div>
        </li>

        <hr class="sidebar-divider d-none d-md-block">
        <div class="sidebar-heading">User</div>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('user.profile') }}">
                <i class="fas fa-fw fa-user"></i>
                <span>Profile</span>
            </a>
        </li>
    </ul>
    <!-- End Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>
                <!-- Topbar Navbar -->
                <ul class="navbar-nav ml-auto">
                    <!-- User Information -->
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="mr-2 d-none d-lg-inline text-gray-600 small">
                                {{ user_info.UserName or "No Name" }}
                                {% if user_info.type %}
                                    ({{ user_info.type }})
                                {% endif %}
                            </span>
                            <img class="img-profile rounded-circle" src="{{ url_for('static', filename='img/undraw_profile.svg') }}">
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                            <a class="dropdown-item" href="{{ url_for('user.profile') }}">
                                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> Profile
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i> Logout
                            </a>
                        </div>
                    </li>
                </ul>
            </nav>
            <!-- End Topbar -->

            <!-- Page Content -->
            <div class="container-fluid">
                <h1 class="h3 mb-4 text-gray-800">S3 Buckets</h1>

                <!-- Create Bucket Button -->
                <div class="mb-3 text-right">
                    <button class="btn btn-success btn-lg shadow" data-toggle="modal" data-target="#createBucketModal">
                        <i class="fas fa-plus"></i> Create Bucket
                    </button>
                </div>

                <!-- Buckets Table -->
                <div class="card shadow-lg border-0 rounded-lg">
                    <div class="card-header py-3 bg-gradient-primary text-white">
                        <h6 class="m-0 font-weight-bold">Buckets List</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="bucketsTable" class="table table-hover table-striped table-bordered align-middle text-center">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Bucket Name</th>
                                        <th>Region</th>
                                        <th>Creation Date</th>
                                        <th>Versioning</th>
                                        <th>Size (MB)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bucket in buckets %}
                                    <tr>
<td>
    <div class="text-center">
        <!-- Bucket Name -->
        <div class="mb-2">
            <span class="badge badge-primary badge-lg px-3 py-2">
                <i class="fas fa-cube mr-2"></i>{{ bucket.Name }}
            </span>
        </div>
        
        <!-- Bucket Tags -->
        <div class="bucket-tags-pretty">
            {% if bucket.Tags %}
                <div class="tags-container">
                    {% for tag in bucket.Tags %}
                        <span class="tag-pretty">
                            <i class="fas fa-tag mr-1"></i>
                            <span class="tag-text">{{ tag.Key }}: {{ tag.Value }}</span>
                        </span>
                    {% endfor %}
                </div>
            {% else %}
                <span class="no-tags-pretty">
                    <i class="fas fa-tag mr-1"></i>
                    <small>No tags</small>
                </span>
            {% endif %}
        </div>
    </div>
</td>
                                        <td>{{ bucket.Region }}</td>
                                        <td>{{ bucket.CreationDate }}</td>
<td>
    {% if bucket.Versioning %}
        <span class="badge badge-success px-3 py-2">
            <i class="fas fa-check-circle mr-2"></i>Enabled
        </span>
    {% else %}
        <span class="badge badge-secondary px-3 py-2">
            <i class="fas fa-times-circle mr-2"></i>Disabled
        </span>
    {% endif %}
</td>
                                        <td data-sort="{{ bucket.Size if bucket.Size else 0 }}">{{ bucket.Size if bucket.Size else 0 }}</td>
                                        <td>
    <div class="text-center">
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle action-btn" type="button" 
                    id="dropdownMenuButton-{{ bucket.Name }}" data-toggle="dropdown" 
                    aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-cog"></i> Actions
            </button>
            <div class="dropdown-menu dropdown-menu-right shadow" aria-labelledby="dropdownMenuButton-{{ bucket.Name }}">
                <a class="dropdown-item manage-tags-btn" href="#" data-bucket="{{ bucket.Name }}">
                    <i class="fas fa-tags text-warning"></i> Manage Tags
                </a>
                <a class="dropdown-item policy-btn" href="#" data-bucket="{{ bucket.Name }}">
                    <i class="fas fa-file-contract text-info"></i> Bucket Policy
                </a>
                <a class="dropdown-item lifecycle-btn" href="#" data-bucket="{{ bucket.Name }}">
                    <i class="fas fa-recycle text-warning"></i> Lifecycle
                </a>
                <a class="dropdown-item replication-btn" href="#" data-bucket="{{ bucket.Name }}">
                    <i class="fas fa-random text-success"></i> Replication
                </a>
                <a class="dropdown-item versioning-btn" href="#" data-bucket="{{ bucket.Name }}">
                    <i class="fas fa-sync-alt text-secondary"></i> Toggle Versioning
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item delete-bucket-btn text-danger" href="#" data-bucket="{{ bucket.Name }}">
                    <i class="fas fa-trash"></i> Delete Bucket
                </a>
            </div>
        </div>
    </div>
</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- End Buckets Table -->
            </div>
        </div>
    </div>
</div>

<!-- Create Bucket Modal -->
<div class="modal fade" id="createBucketModal" tabindex="-1" role="dialog" aria-labelledby="createBucketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content shadow-lg border-0 rounded-lg">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title font-weight-bold">
                    <i class="fas fa-plus-circle"></i> Create New Bucket
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <form id="createBucketForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="bucketName" class="font-weight-bold">Bucket Name</label>
                        <input type="text" class="form-control" id="bucketName" name="bucket_name" placeholder="Enter bucket name..." required>
                    </div>
                    <div class="form-group">
                        <label for="bucketRegion" class="font-weight-bold">Region</label>
                        <select class="form-control" id="bucketRegion">
                            <option value="default" selected>Default</option>
                            <option value="us-east-1">US East (N. Virginia)</option>
                            <option value="us-west-1">US West (N. California)</option>
                            <option value="us-west-2">US West (Oregon)</option>
                            <option value="eu-central-1">EU (Frankfurt)</option>
                            <option value="ap-south-1">Asia Pacific (Mumbai)</option>
                        </select>
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="bucketLocking">
                        <label class="form-check-label" for="bucketLocking">Enable Object Locking</label>
                    </div>
                    <div id="createBucketResult" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manage Tags Modal -->
<div class="modal fade" id="manageTagsModal" tabindex="-1" role="dialog" aria-labelledby="manageTagsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content shadow-lg border-0 rounded-lg">
            <div class="modal-header bg-gradient-warning text-white">
                <h5 class="modal-title font-weight-bold">
                    <i class="fas fa-tags"></i> Manage Tags for <span id="tagsBucketName"></span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered" id="tagsTable">
                    <thead class="thead-light">
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- تگ‌ها از سرور اینجا لود می‌شوند -->
                    </tbody>
                </table>
                <hr>
                <h6 class="font-weight-bold">Add New Tag</h6>
                <form id="newTagForm">
                    <div class="form-row">
                        <div class="col">
                            <input type="text" class="form-control" id="newTagKey" placeholder="Key" required>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" id="newTagValue" placeholder="Value" required>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-success btn-sm" id="addNewTagBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Bucket Policy Modal -->
<div class="modal fade" id="bucketPolicyModal" tabindex="-1" role="dialog" aria-labelledby="bucketPolicyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content shadow-lg border-0 rounded-lg">
            <div class="modal-header bg-gradient-info text-white">
                <h5 class="modal-title font-weight-bold">
                    <i class="fas fa-file-contract"></i> Bucket Policy for <span id="policyBucketName"></span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="json-viewer" id="policyContent">
                    Loading policy...
                </div>
                <div class="mt-3" id="policyEditorSection" style="display:none;">
                    <textarea id="policyEditor" class="form-control" rows="10" style="font-family: 'Courier New', monospace;"></textarea>
                    <div class="mt-2">
                        <button class="btn btn-primary" id="savePolicyBtn">
                            <i class="fas fa-save"></i> Save Policy
                        </button>
                        <button class="btn btn-secondary" id="cancelPolicyBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="editPolicyBtn" class="btn btn-warning">
                    <i class="fas fa-edit"></i> Edit Policy
                </button>
                <button id="deletePolicyBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete Policy
                </button>
                <button class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Lifecycle Modal -->
<div class="modal fade" id="bucketLifecycleModal" tabindex="-1" role="dialog" aria-labelledby="bucketLifecycleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content shadow-lg border-0 rounded-lg">
            <div class="modal-header bg-gradient-warning text-white">
                <h5 class="modal-title font-weight-bold">
                    <i class="fas fa-recycle"></i> Lifecycle Configuration for <span id="lifecycleBucketName"></span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="json-viewer" id="lifecycleContent">
                    Loading lifecycle configuration...
                </div>
                <div class="mt-3" id="lifecycleEditorSection" style="display:none;">
                    <textarea id="lifecycleEditor" class="form-control" rows="10" style="font-family: 'Courier New', monospace;"></textarea>
                    <div class="mt-2">
                        <button class="btn btn-primary" id="saveLifecycleBtn">
                            <i class="fas fa-save"></i> Save Lifecycle
                        </button>
                        <button class="btn btn-secondary" id="cancelLifecycleBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="editLifecycleBtn" class="btn btn-warning">
                    <i class="fas fa-edit"></i> Edit Lifecycle
                </button>
                <button id="deleteLifecycleBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete Lifecycle
                </button>
                <button class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Replication Modal -->
<div class="modal fade" id="replicationModal" tabindex="-1" role="dialog" aria-labelledby="replicationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content shadow-lg border-0 rounded-lg">
            <div class="modal-header bg-gradient-success text-white">
                <h5 class="modal-title font-weight-bold">
                    <i class="fas fa-random"></i> Replication Rules for <span id="replicationBucketName"></span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="json-viewer" id="replicationContent">
                    Loading replication rules...
                </div>
                <div class="mt-3" id="replicationEditorSection" style="display:none;">
                    <textarea id="replicationEditor" class="form-control" rows="10" style="font-family: 'Courier New', monospace;"></textarea>
                    <div class="mt-2">
                        <button class="btn btn-primary" id="saveReplicationBtn">
                            <i class="fas fa-save"></i> Save Replication
                        </button>
                        <button class="btn btn-secondary" id="cancelReplicationBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="editReplicationBtn" class="btn btn-warning">
                    <i class="fas fa-edit"></i> Edit Replication
                </button>
                <button id="deleteReplicationBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete Replication
                </button>
                <button class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/jquery-easing/jquery.easing.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function() {
    // فعال کردن DataTables با قابلیت سورت برای همه ستون‌ها
    const table = $('#bucketsTable').DataTable({
        "paging": true,
        "pageLength": 10,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
        "language": {
            "paginate": {
                "previous": "‹",
                "next": "›"
            },
            "search": "Search:",
            "lengthMenu": "Show _MENU_ entries",
            "info": "Showing _START_ to _END_ of _TOTAL_ entries",
            "infoEmpty": "Showing 0 to 0 of 0 entries",
            "infoFiltered": "(filtered from _MAX_ total entries)",
            "emptyTable": "No data available in table",
            "zeroRecords": "No matching records found",
            "loadingRecords": "Loading...",
            "processing": "Processing..."
        },
        "columnDefs": [
            {
                "targets": [4], // ستون Size (ایندکس 4)
                "type": "num", // نوع عددی برای سورت کردن
                "render": function(data, type, row) {
                    if (type === 'sort' || type === 'type') {
                        return parseFloat(data) || 0;
                    }
                    return data;
                }
            },
            {
                "targets": [3], // ستون Versioning
                "type": "string",
                "render": function(data, type, row) {
                    if (type === 'sort' || type === 'type') {
                        // بررسی مستقیم محتوای HTML برای تشخیص وضعیت versioning
                        return data.includes('badge-success') ? 1 : 0;
                    }
                    return data;
                }
            },
            {
                "targets": [0], // ستون Bucket Name
                "orderable": true
            },
            {
                "targets": [1], // ستون Region
                "orderable": true
            },
            {
                "targets": [2], // ستون Creation Date
                "orderable": true,
                "type": "date"
            },
            {
                "targets": [5], // ستون Actions
                "orderable": false // غیرفعال کردن سورت برای ستون Actions
            }
        ],
        "order": [[0, "asc"]], // سورت پیش‌فرض بر اساس نام bucket
        "drawCallback": function(settings) {
            // فعال کردن tooltip پس از هر بار رسم جدول
            $('[data-toggle="tooltip"]').tooltip();
        }
    });

    // فعال کردن tooltip
    $('[data-toggle="tooltip"]').tooltip();

    // Create Bucket
    $("#createBucketForm").submit(function(e) {
        e.preventDefault();
        const data = { 
            bucket_name: $("#bucketName").val(),
            region: $("#bucketRegion").val(),
            enable_locking: $("#bucketLocking").is(":checked")
        };
        const $result = $("#createBucketResult");
        $result.html('');
        
        $.ajax({
            url: "/create_bucket",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(response) {
                if(response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Bucket Created',
                        text: `Bucket "${data.bucket_name}" created successfully`,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    $result.html('<div class="alert alert-danger">' + (response.message || "Error creating bucket.") + '</div>');
                }
            },
            error: function(err) {
                $result.html('<div class="alert alert-danger">AJAX error: ' + err.statusText + '</div>');
            }
        });
    });

    // Delete Bucket
    $(document).on("click", ".delete-bucket-btn", function() {
        const bucketName = $(this).data("bucket");

        Swal.fire({
            title: 'Delete Bucket',
            html: `Are you sure you want to delete bucket <strong>"${bucketName}"</strong>?<br><br>
                   <small class="text-danger">⚠️ This action cannot be undone!</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Deleting Bucket...',
                    text: 'Please wait while we delete the bucket',
                    allowOutsideClick: false,
                    didOpen: function() {
                        Swal.showLoading();
                    }
                });

                $.ajax({
                    url: "/delete_bucket",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ bucket_name: bucketName }),
                    success: function(response) {
                        Swal.close();
                        if(response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Bucket Deleted!',
                                text: `Bucket "${bucketName}" has been deleted successfully`,
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Cannot Delete Bucket',
                                html: `❌ ${response.message || "Failed to delete bucket."}<br><br>
                                       <small>Please empty the bucket first and try again.</small>`
                            });
                        }
                    },
                    error: function(err) {
                        Swal.close();
                        let errorMessage = "An error occurred while deleting the bucket.";
                        
                        if (err.responseJSON && err.responseJSON.message) {
                            errorMessage = err.responseJSON.message;
                        } else if (err.statusText) {
                            errorMessage = `Server error: ${err.statusText}`;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Delete Failed',
                            text: errorMessage
                        });
                    }
                });
            }
        });
    });

    // Toggle Versioning - نسخه اصلاح شده
    $(document).on("click", ".versioning-btn", function() {
        const bucketName = $(this).data("bucket");
        const $btn = $(this);
        const originalText = $btn.html();
        
        $btn.prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');

        // پیدا کردن ردیف مربوطه در جدول
        const $row = $btn.closest('tr');
        const $versioningBadge = $row.find('td').eq(3).find('.badge');
        const isCurrentlyEnabled = $versioningBadge.hasClass('badge-success');
        
        const action = isCurrentlyEnabled ? "disable" : "enable";

        fetch("/toggle_versioning", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ bucket_name: bucketName, action: action })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const newStatus = action === 'enable' ? 'Enabled' : 'Disabled';
                Swal.fire({
                    icon: 'success',
                    title: 'Versioning Updated',
                    text: `Versioning for bucket "${bucketName}" is now ${newStatus}`,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => location.reload());
            } else {
                throw new Error(data.message || "Failed to update versioning");
            }
        })
        .catch(err => {
            Swal.fire('Error', err.message || "Failed to update versioning", 'error');
            $btn.html(originalText).prop("disabled", false);
        });
    });

    // Manage Tags
    let currentBucket = null;

    function loadTags(bucketName) {
        fetch(`/get_bucket_tags?bucket_name=${bucketName}`)
            .then(res => res.json())
            .then(data => {
                const tbody = $("#tagsTable tbody");
                tbody.empty();
                if (data.success && data.tags) {
                    data.tags.forEach(tag => {
                        tbody.append(`
                            <tr>
                                <td>${tag.Key}</td>
                                <td>${tag.Value}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger delete-tag-btn" data-key="${tag.Key}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                } else {
                    tbody.append('<tr><td colspan="3" class="text-center">No tags found</td></tr>');
                }
            });
    }

    $(document).on("click", ".manage-tags-btn", function() {
        currentBucket = $(this).data("bucket");
        $("#tagsBucketName").text(currentBucket);
        loadTags(currentBucket);
        $("#manageTagsModal").modal("show");
    });

    $(document).on("click", ".delete-tag-btn", function() {
        const key = $(this).data("key");
        fetch("/delete_bucket_tag", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ bucket_name: currentBucket, key: key })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Tag Deleted',
                    text: `Tag "${key}" deleted successfully`,
                    timer: 1500,
                    showConfirmButton: false
                });
                loadTags(currentBucket);
            } else {
                Swal.fire('Error', data.message || "Failed to delete tag", 'error');
            }
        });
    });

    $("#addNewTagBtn").click(function() {
        const key = $("#newTagKey").val().trim();
        const value = $("#newTagValue").val().trim();
        if (!key || !value) {
            Swal.fire('Warning', 'Both key and value are required.', 'warning');
            return;
        }
        fetch("/add_bucket_tag", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ bucket_name: currentBucket, key: key, value: value })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Tag Added',
                    text: `Tag "${key}" added successfully`,
                    timer: 1500,
                    showConfirmButton: false
                });
                $("#newTagKey").val("");
                $("#newTagValue").val("");
                loadTags(currentBucket);
            } else {
                Swal.fire('Error', data.message || "Failed to add tag", 'error');
            }
        });
    });

    // Bucket Policy Management
    let currentPolicyBucket = null;
    let currentPolicyRaw = null;

    $(document).on("click", ".policy-btn", function() {
        currentPolicyBucket = $(this).data("bucket");
        $("#policyBucketName").text(currentPolicyBucket);
        $("#policyContent").text("Loading policy...");
        $("#policyEditorSection").hide();
        $("#editPolicyBtn").show();
        $("#bucketPolicyModal").modal("show");

        fetch(`/get_bucket_policies?bucket_name=${currentPolicyBucket}`)
            .then(res => res.json())
            .then(data => {
                if(data.success && data.policies && data.policies.length > 0) {
                    currentPolicyRaw = data.policies[0];
                    $("#policyContent").text(JSON.stringify(JSON.parse(currentPolicyRaw), null, 2));
                } else {
                    currentPolicyRaw = null;
                    $("#policyContent").text("No policy found.");
                }
            })
            .catch(err => {
                $("#policyContent").text("Error loading policy: " + err);
            });
    });

    $("#editPolicyBtn").click(function() {
        $("#policyContent").hide();
        $("#editPolicyBtn").hide();

        if(currentPolicyRaw) {
            $("#policyEditor").val(JSON.stringify(JSON.parse(currentPolicyRaw), null, 2));
        } else {
            $("#policyEditor").val(`{
  "Version": "2012-10-17",
  "Statement": []
}`);
        }
        $("#policyEditorSection").show();
    });

    $("#cancelPolicyBtn").click(function() {
        $("#policyEditorSection").hide();
        $("#policyContent").show();
        $("#editPolicyBtn").show();
    });

    $("#savePolicyBtn").click(function() {
        let newPolicy = $("#policyEditor").val();
        try {
            JSON.parse(newPolicy);
        } catch(e) {
            Swal.fire('Error', "Invalid JSON format: " + e.message, 'error');
            return;
        }

        fetch("/set_bucket_policy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                bucket_name: currentPolicyBucket,
                policy: newPolicy
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Policy Saved',
                    text: 'Bucket policy updated successfully',
                    timer: 1500,
                    showConfirmButton: false
                });
                $("#policyContent").text(JSON.stringify(JSON.parse(newPolicy), null, 2)).show();
                $("#policyEditorSection").hide();
                $("#editPolicyBtn").show();
                currentPolicyRaw = newPolicy;
            } else {
                Swal.fire('Error', data.message || "Failed to save policy", 'error');
            }
        })
        .catch(err => Swal.fire('Error', "Server error: " + err, 'error'));
    });

    $("#deletePolicyBtn").click(function() {
        if(!currentPolicyBucket) {
            Swal.fire('Warning', "Bucket not selected!", 'warning');
            return;
        }

        Swal.fire({
            title: 'Delete Policy',
            text: `Are you sure you want to delete the policy for ${currentPolicyBucket}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("/delete_bucket_policy", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ bucket_name: currentPolicyBucket })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Policy Deleted',
                            text: 'Bucket policy deleted successfully',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        $("#bucketPolicyModal").modal("hide");
                    } else {
                        Swal.fire('Error', data.message || "Failed to delete policy", 'error');
                    }
                })
                .catch(err => Swal.fire('Error', "Server error: " + err, 'error'));
            }
        });
    });

    // Lifecycle Management
    let currentLifecycleBucket = null;
    let currentLifecycleRaw = null;

    $(document).on("click", ".lifecycle-btn", function() {
        currentLifecycleBucket = $(this).data("bucket");
        $("#lifecycleBucketName").text(currentLifecycleBucket);
        $("#lifecycleContent").text("Loading lifecycle configuration...");
        $("#lifecycleEditorSection").hide();
        $("#editLifecycleBtn").show();
        $("#bucketLifecycleModal").modal("show");

        fetch(`/get_bucket_lifecycle?bucket_name=${currentLifecycleBucket}`)
            .then(res => res.json())
            .then(data => {
                if(data.success && data.lifecycle && data.lifecycle.length > 0) {
                    currentLifecycleRaw = JSON.stringify(data.lifecycle, null, 2);
                    $("#lifecycleContent").text(currentLifecycleRaw);
                } else {
                    currentLifecycleRaw = null;
                    $("#lifecycleContent").text("No lifecycle configuration found.");
                }
            })
            .catch(err => {
                $("#lifecycleContent").text("Error loading lifecycle: " + err);
            });
    });

    $("#editLifecycleBtn").click(function() {
        $("#lifecycleContent").hide();
        $("#editLifecycleBtn").hide();

        if(currentLifecycleRaw) {
            $("#lifecycleEditor").val(currentLifecycleRaw);
        } else {
            $("#lifecycleEditor").val(`[
  {
    "ID": "ExpireOldObjects",
    "Status": "Enabled",
    "Filter": { "Prefix": "" },
    "Expiration": { "Days": 30 }
  }
]`);
        }
        $("#lifecycleEditorSection").show();
    });

    $("#cancelLifecycleBtn").click(function() {
        $("#lifecycleEditorSection").hide();
        $("#lifecycleContent").show();
        $("#editLifecycleBtn").show();
    });

    $("#saveLifecycleBtn").click(function() {
        let newLifecycle = $("#lifecycleEditor").val();
        try {
            JSON.parse(newLifecycle);
        } catch(e) {
            Swal.fire('Error', "Invalid JSON format: " + e.message, 'error');
            return;
        }

        fetch("/set_bucket_lifecycle", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                bucket_name: currentLifecycleBucket,
                lifecycle: newLifecycle
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Lifecycle Saved',
                    text: 'Lifecycle configuration updated successfully',
                    timer: 1500,
                    showConfirmButton: false
                });
                $("#lifecycleContent").text(JSON.stringify(JSON.parse(newLifecycle), null, 2)).show();
                $("#lifecycleEditorSection").hide();
                $("#editLifecycleBtn").show();
                currentLifecycleRaw = newLifecycle;
            } else {
                Swal.fire('Error', data.message || "Failed to save lifecycle", 'error');
            }
        })
        .catch(err => Swal.fire('Error', "Server error: " + err, 'error'));
    });

    $("#deleteLifecycleBtn").click(function() {
        if(!currentLifecycleBucket) return Swal.fire('Warning', "Bucket not selected", 'warning');
        
        Swal.fire({
            title: 'Delete Lifecycle',
            text: `Are you sure you want to delete lifecycle configuration for ${currentLifecycleBucket}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("/delete_bucket_lifecycle", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ bucket_name: currentLifecycleBucket })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Lifecycle Deleted',
                            text: 'Lifecycle configuration deleted successfully',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        $("#bucketLifecycleModal").modal("hide");
                    } else {
                        Swal.fire('Error', data.message || "Failed to delete lifecycle", 'error');
                    }
                })
                .catch(err => Swal.fire('Error', "Server error: " + err, 'error'));
            }
        });
    });

    // Replication Management
    let currentReplicationBucket = null;
    let currentReplicationRaw = null;

    // تابع برای باز کردن مودال replication
    function openReplicationModal(bucketName) {
        currentReplicationBucket = bucketName;
        $("#replicationBucketName").text(bucketName);
        $("#replicationContent").text("Loading replication rules...");
        $("#replicationEditorSection").hide();
        $("#editReplicationBtn").show();
        $("#replicationModal").modal("show");

        fetch(`/get_bucket_replication?bucket_name=${bucketName}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.replication && data.replication.Rules) {
                    currentReplicationRaw = JSON.stringify(data.replication.Rules, null, 2);
                    $("#replicationContent").text(currentReplicationRaw);
                } else {
                    currentReplicationRaw = null;
                    $("#replicationContent").text("No replication rules found.");
                }
            })
            .catch(err => {
                $("#replicationContent").text("Error loading replication rules: " + err);
            });
    }

    // Event handler برای دکمه‌های replication
    $(document).on("click", ".replication-btn", function(e) {
        e.stopPropagation();
        const bucketName = $(this).data("bucket");
        openReplicationModal(bucketName);
    });

    $("#editReplicationBtn").click(function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        $("#replicationContent").hide();
        $("#editReplicationBtn").hide();

        if(currentReplicationRaw) {
            $("#replicationEditor").val(currentReplicationRaw);
        } else {
            $("#replicationEditor").val("[]");
        }
        $("#replicationEditorSection").show();
        
        return false;
    });

    $("#cancelReplicationBtn").click(function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        $("#replicationEditorSection").hide();
        $("#replicationContent").show();
        $("#editReplicationBtn").show();
        
        return false;
    });

    $("#saveReplicationBtn").click(function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        let newReplication = $("#replicationEditor").val();
        let rules = [];
        try {
            rules = JSON.parse(newReplication);
        } catch (e) {
            Swal.fire('Error', "Invalid JSON format", 'error');
            return false;
        }

        fetch("/apply_replication_rule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                bucket_name: currentReplicationBucket,
                replication: {
                    Role: "", 
                    Rules: rules
                }
            })
        })
        .then(res => res.json())
        .then(result => {
            if(result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Replication Saved',
                    text: 'Replication rules updated successfully',
                    timer: 1500,
                    showConfirmButton: false
                });
                $("#replicationContent").text(JSON.stringify(rules, null, 2)).show();
                $("#replicationEditorSection").hide();
                $("#editReplicationBtn").show();
                currentReplicationRaw = newReplication;
            } else {
                Swal.fire('Error', result.message || "Failed to save replication rules", 'error');
            }
        })
        .catch(err => {
            Swal.fire('Error', "Error saving replication rules: " + err, 'error');
        });
        
        return false;
    });

    $("#deleteReplicationBtn").click(function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        if(!currentReplicationBucket) return Swal.fire('Warning', "Bucket not selected", 'warning');
        
        Swal.fire({
            title: 'Delete Replication',
            text: `Are you sure you want to delete replication rules for ${currentReplicationBucket}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Deleting Replication...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: function() {
                        Swal.showLoading();
                    }
                });

                fetch("/delete_bucket_replication", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ bucket_name: currentReplicationBucket })
                })
                .then(res => res.json())
                .then(data => {
                    Swal.close();
                    if(data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Replication Deleted',
                            text: data.message || 'Replication rules deleted successfully',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        $("#replicationContent").text("No replication rules found.");
                        currentReplicationRaw = null;
                        setTimeout(function() {
                            $("#replicationModal").modal("hide");
                        }, 1500);
                    } else {
                        Swal.fire('Error', data.message || "Failed to delete replication rules", 'error');
                    }
                })
                .catch(err => {
                    Swal.close();
                    Swal.fire('Error', "Error deleting replication rules: " + err, 'error');
                });
            }
        });
        
        return false;
    });
});
</script>

<!-- Logout Modal-->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logoutModalLabel">Ready to Leave?</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                <a class="btn btn-primary" href="{{ url_for('auth.logout') }}">Logout</a>
            </div>
        </div>
    </div>
</div>

</body>
</html>